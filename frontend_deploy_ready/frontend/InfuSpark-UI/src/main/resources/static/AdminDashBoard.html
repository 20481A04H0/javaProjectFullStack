<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | InfuSpark</title>

  <!-- Bootstrap & Font Awesome -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="AdminDashBoard.css" />


</head>
<div>
<div><body>

	<div class="dashboard-container">

	    <!-- âœ… Sidebar -->
	    <div class="sidebar">
			<a class="navbar-brand" href="#">
			  <img src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/08716313-e0fc-47a7-bc8a-4a1c17d2fa2a.png"
			       alt="InfuSpark Logo"
			       style="height: 44px; background: white; border-radius: 10px; box-shadow: 0 1px 7px #e297ff4c; padding: 2px 6px;">
			  <span style="font-weight:700; font-size:1.25rem; color:#5699fa; margin-left:10px; letter-spacing:1px;">
			    InfuSpark
			  </span>
			</a>
	      <a id="dashboardLink" class="sidebar-link active-link" onclick="setActiveLink(this); showDashboard();"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
		  <a class="sidebar-link" onclick="setActiveLink(this); loadStudents();"><i class="fas fa-user-graduate"></i> Students</a>
	      <a id="trainersLink" class="sidebar-link" onclick="setActiveLink(this); loadTrainers();"><i class="fas fa-chalkboard-teacher"></i> Trainers</a>
	      <a id="coursesLink" class="sidebar-link" onclick="setActiveLink(this); loadCourses();"><i class="fas fa-book"></i> Courses</a>
		  <a class="sidebar-link" id="attendanceLink" onclick="setActiveLink(this); showAttendanceUploadForm();">
		    <i class="fas fa-cogs"></i> Attendance
		  </a>
	      <a href="HomePage.html" class="sidebar-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
	    </div>
    <!-- âœ… Main Content -->
	
    <div id="mainContent" class="content">
      <h2 class="mb-4">Welcome Admin ðŸ‘‹</h2>
      <p>This is your admin control panel. Use the sidebar to navigate.</p>

 	  
	  <div id="courseSection" style="display: none;">
	  	<div class="course-top-bar mb-3 text-left">
	  	 
	  	  <h3 class="mt-2">Courses List</h3>
	  	</div>

	         <div id="courseCreationSection" style="display: none;"></div>
	         <div id="courseTableSection">
	           <!-- Trainer table will load here -->
	         </div>

	         <!-- Page size dropdown -->
	         <div class="mt-4">
	           <label for="pageSizeDropdown" class="form-label">Courses per page:</label>
	           <select id="pageSizeDropdown" class="form-control d-inline-block" style="width: 100px;" onchange="updatePageSize()">
	             <option value="5" selected>5</option>
	             <option value="10">10</option>
	             <option value="20">20</option>
	           </select>
	         </div>
	       </div>
	    
	  
	  
	  
	  
      <!-- âœ… Trainer Section -->
      <div id="trainerSection" style="display: none;">
		
		<div class="trainer-top-bar mb-3 text-left">
	
		  <h3 class="mt-2">Trainer List</h3>
		</div>

        <div id="trainerCreationSection" style="display: none;"></div>
        <div id="trainerTableSection">
          <!-- Trainer table will load here -->
        </div>

        <!-- Page size dropdown -->
       <div class="mt-4">
          <label for="pageSizeDropdown" class="form-label">Trainers per page:</label>
          <select id="pageSizeDropdown" class="form-control d-inline-block" style="width: 100px;" onchange="updatePageSize()">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
   
	  </div>
    <!-- âœ… Fixed Admin Profile Icon -->
    <div class="admin-profile">
      <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Admin" onclick="toggleAdminInfo()" title="Admin Info">
	  <div id="adminInfo" class="admin-info-card">
	    <p><strong>Name:</strong> <span id="adminName">Loading...</span></p>
	    <p><strong>Email:</strong> <span id="adminEmail">Loading...</span></p>
	    <p><strong>Phone:</strong> <span id="adminPhone">Loading...</span></p>
	    <hr>
	    <button class="btn btn-sm btn-danger btn-block" onclick="logout()">Logout</button>
	  </div>
    </div>

  </div>
</div>

  <!-- Scripts -->
  <script>
    // Global variables
    let students = [];
    let currentStudentPage = 1;
    let studentsPerPage = 5;

    function setActiveLink(clicked) {
      document.querySelectorAll('.sidebar-link:not(.logout-link)').forEach(link => link.classList.remove('active-link'));
      if (!clicked.classList.contains('logout-link')) {
        clicked.classList.add('active-link');
      }
    }

    function showDashboard() {
      const content = `
        <h2 class="mb-4">Dashboard Overview</h2>
        <div class="row">
          <div class="col-md-4 mb-4">
            <div class="card card-box card-students shadow-sm p-4">
              <div class="card-icon"><i class="fas fa-users"></i></div>
              <div class="card-title">Total Students</div>
               <h6>Total Students: <span id="studentsCount">0</span></h6>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card card-box card-trainers shadow-sm p-4">
              <div class="card-icon"><i class="fas fa-chalkboard-teacher"></i></div>
              <div class="card-title">Active Trainers</div>
        <h6>Total Trainers: <span id="trainersCount">0</span></h6>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card card-box card-courses shadow-sm p-4">
              <div class="card-icon"><i class="fas fa-book-open"></i></div>
              <div class="card-title">Running Courses</div>
              <h6>Total Courses: <span id="coursesCount">0</span></h6>
            </div>
          </div>
        </div>
      `;
      document.getElementById("mainContent").innerHTML = content;
      
      // Load counts
      fetch('http://localhost:8080/api/course/getCoursesCount')
        .then(response => response.json())
        .then(data => {
          const element = document.getElementById('coursesCount');
          if (element) element.textContent = data;
        })
        .catch(error => {
          console.error("Error fetching courses:", error);
          const element = document.getElementById('coursesCount');
          if (element) element.textContent = "Error";
        });
      
      fetch('http://localhost:8080/api/student/getStudentsCount')
        .then(response => response.json())
        .then(data => {
          const element = document.getElementById('studentsCount');
          if (element) element.textContent = data;
        })
        .catch(error => {
          console.error("Error fetching students:", error);
          const element = document.getElementById('studentsCount');
          if (element) element.textContent = "Error";
        });
      
      fetch('http://localhost:8080/api/trainer/getAllTrainers')
        .then(response => response.json())
        .then(data => {
          const element = document.getElementById('trainersCount');
          if (element) element.textContent = data.length;
        })
        .catch(error => {
          console.error("Error fetching trainers:", error);
          const element = document.getElementById('trainersCount');
          if (element) element.textContent = "Error";
        });
    }

    function loadStudents() {
        console.log("Students link clicked");
        const main = document.getElementById("mainContent");

        const studentsHTML = `
            <div class="container mt-4" id="studentSection">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <h3 class="mb-0">Student List</h3>
                    <button class="btn btn-primary" onclick="loadStudentForm()">Add Student</button>
                </div>
                <table class="table table-striped" id="studentTable">
                    <thead>
                        <tr>
                          <th>S.No</th>
                          <th>ID</th>
                          <th>FirstName</th>
                          <th>LastName</th>
                          <th>Email</th>
                          <th>Phone</th>
                          <th>Address</th>
                          <th>Courses</th>
                          <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem;">
              <div class="mb-3" style="margin-bottom: 0;">
                <label for="studentPageSizeDropdown" class="form-label" style="margin-right: 8px;">Students per page:</label>
                <select id="studentPageSizeDropdown" class="form-select w-auto d-inline" onchange="updateStudentPageSize()">
                  <option value="5" selected>5</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                </select>
              </div>
              <ul id="studentPaginationControls" class="pagination mb-0"></ul>
            </div>
        `;

        main.innerHTML = studentsHTML;

        fetch('http://localhost:8080/api/student/getAllStudents')
            .then(res => res.json())
            .then(data => {
                students = data;
                renderStudents();
                setupStudentPagination();
            })
            .catch(err => console.error('Error fetching students:', err));
    }

    function renderStudents() {
        const tableBody = document.querySelector('#studentTable tbody');
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const startIndex = (currentStudentPage - 1) * studentsPerPage;
        const endIndex = Math.min(startIndex + studentsPerPage, students.length);

        for (let i = startIndex; i < endIndex; i++) {
            const student = students[i];
            const row = document.createElement('tr');
            const courseNames = student.courses ? student.courses.map(c => c.name).join(', ') : 'None';
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${student.id}</td>
                <td>${student.firstName}</td>
                <td>${student.lastName}</td>
                <td>${student.email}</td>
                <td>${student.phone}</td>
                <td>${student.address || "-"}</td>
                <td>${courseNames}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="openUpdateStudentForm('${student.id}')">Update</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        }
    }

    function setupStudentPagination() {
        const pagination = document.getElementById('studentPaginationControls');
        pagination.innerHTML = '';
        if (students.length === 0) return;

        const totalPages = Math.ceil(students.length / studentsPerPage);

        const prev = document.createElement('li');
        prev.className = `page-item${currentStudentPage === 1 ? ' disabled' : ''}`;
        prev.innerHTML = `<a class="page-link" href="#" onclick="changeStudentPage(${currentStudentPage - 1})">Previous</a>`;
        pagination.appendChild(prev);

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item${currentStudentPage === i ? ' active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changeStudentPage(${i})">${i}</a>`;
            pagination.appendChild(li);
        }

        const next = document.createElement('li');
        next.className = `page-item${currentStudentPage === totalPages ? ' disabled' : ''}`;
        next.innerHTML = `<a class="page-link" href="#" onclick="changeStudentPage(${currentStudentPage + 1})">Next</a>`;
        pagination.appendChild(next);
    }

    function changeStudentPage(page) {
        const totalPages = Math.ceil(students.length / studentsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentStudentPage = page;
            renderStudents();
            setupStudentPagination();
        }
    }

    function updateStudentPageSize() {
        const dropdown = document.getElementById('studentPageSizeDropdown');
        studentsPerPage = parseInt(dropdown.value);
        currentStudentPage = 1;
        renderStudents();
        setupStudentPagination();
    }

    function loadStudentForm() {
        fetch('http://localhost:8080/api/course/allCourse')
            .then(res => res.json())
            .then(courses => {
                const main = document.getElementById("mainContent");
                const courseOptions = courses.map(course => 
                    `<option value="${course.id}">${course.name}</option>`
                ).join('');
                
                const addFormHTML = `
                    <div class="container" id="addStudentSection">
                        <h3>Add New Student</h3>
                        <form id="addStudentForm" novalidate>
                            <div class="mb-3">
                                <label for="addStudentFirstName" class="form-label">FirstName</label>
                                <input type="text" class="form-control" id="addStudentFirstName" required>
                            </div>
                            <div class="mb-3">
                                <label for="addStudentLastName" class="form-label">LastName</label>
                                <input type="text" class="form-control" id="addStudentLastName" required>
                            </div>
                            <div class="mb-3">
                                <label for="addStudentEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="addStudentEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="addStudentPhone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="addStudentPhone" required>
                            </div>
                            <div class="mb-3">
                                <label for="addStudentAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="addStudentAddress" required>
                            </div>
                            <div class="mb-3">
                                <label for="addStudentPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="addStudentPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="addStudentCourses" class="form-label">Select Courses (Optional)</label>
                                <select multiple class="form-control" id="addStudentCourses" style="height: 120px;">
                                    ${courseOptions}
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple courses</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Student</button>
                            <button type="button" class="btn btn-secondary" onclick="loadStudents()">Cancel</button>
                        </form>
                    </div>
                `;
                main.innerHTML = addFormHTML;

                document.getElementById("addStudentForm").addEventListener("submit", function (e) {
                    e.preventDefault();
                    const courseSelect = document.getElementById("addStudentCourses");
                    const selectedCourses = Array.from(courseSelect.selectedOptions).map(option => parseInt(option.value));
                    
                    const newStudent = {
                        firstName: document.getElementById("addStudentFirstName").value.trim(),
                        lastName: document.getElementById("addStudentLastName").value.trim(),
                        email: document.getElementById("addStudentEmail").value.trim(),
                        phone: document.getElementById("addStudentPhone").value.trim(),
                        address: document.getElementById("addStudentAddress").value.trim(),
                        password: document.getElementById("addStudentPassword").value.trim(),
                        courseIds: selectedCourses
                    };
                    
                    fetch('http://localhost:8080/api/student/addStudent', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(newStudent)
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to add student");
                        alert("Student added successfully!");
                        loadStudents();
                    })
                    .catch(err => {
                        console.error("Error adding student:", err);
                        alert("Error adding student.");
                    });
                });
            })
            .catch(err => {
                console.error('Error fetching courses:', err);
                alert('Error loading courses. Please try again.');
            });
    }

    function openUpdateStudentForm(id) {
        Promise.all([
            fetch(`http://localhost:8080/api/student/${id}`).then(res => res.json()),
            fetch('http://localhost:8080/api/course/allCourse').then(res => res.json())
        ])
        .then(([student, courses]) => {
            const studentCourseIds = student.courses ? student.courses.map(c => c.id) : [];
            const courseOptions = courses.map(course => 
                `<option value="${course.id}" ${studentCourseIds.includes(course.id) ? 'selected' : ''}>${course.name}</option>`
            ).join('');
            
            const formHTML = `
                <div class="container" id="updateStudentSection">
                    <h3>Update Student</h3>
                    <form id="updateStudentForm" novalidate>
                        <div class="mb-3">
                            <label for="updateStudentFirstName" class="form-label">FirstName</label>
                            <input type="text" class="form-control" id="updateStudentFirstName" value="${student.firstName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateStudentLastName" class="form-label">LastName</label>
                            <input type="text" class="form-control" id="updateStudentLastName" value="${student.lastName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateStudentEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="updateStudentEmail" value="${student.email}" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateStudentPhone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="updateStudentPhone" value="${student.phone}" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateStudentAddress" class="form-label">Address</label>
                            <input type="text" class="form-control" id="updateStudentAddress" value="${student.address}" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateStudentCourses" class="form-label">Select Courses</label>
                            <select multiple class="form-control" id="updateStudentCourses" style="height: 120px;">
                                ${courseOptions}
                            </select>
                            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple courses</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Student</button>
                        <button type="button" class="btn btn-secondary" onclick="loadStudents()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById("mainContent").innerHTML = formHTML;

            document.getElementById("updateStudentForm").addEventListener("submit", function (e) {
                e.preventDefault();
                const courseSelect = document.getElementById("updateStudentCourses");
                const selectedCourses = Array.from(courseSelect.selectedOptions).map(option => parseInt(option.value));
                
                const updatedStudent = {
                    id: id,
                    firstName: document.getElementById("updateStudentFirstName").value.trim(),
                    lastName: document.getElementById("updateStudentLastName").value.trim(),
                    email: document.getElementById("updateStudentEmail").value.trim(),
                    phone: document.getElementById("updateStudentPhone").value.trim(),
                    address: document.getElementById("updateStudentAddress").value.trim(),
                    courseIds: selectedCourses
                };
                
                fetch('http://localhost:8080/api/student/update', {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedStudent)
                })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to update student");
                    alert("Student updated successfully!");
                    loadStudents();
                })
                .catch(err => {
                    console.error("Error updating student:", err);
                    alert("Error updating student.");
                });
            });
        })
        .catch(err => {
            console.error("Error loading student for update:", err);
            alert("Could not load student details.");
        });
    }

    function deleteStudent(studentId) {
        if (!confirm("Are you sure you want to delete this student?")) return;
        fetch(`http://localhost:8080/api/student/delete/${studentId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) throw new Error("Failed to delete student");
            alert("Student Deleted successfully!");
            loadStudents();
        })
        .catch(error => {
            console.error(error);
            alert("Error deleting student.");
        });
    }

    function loadTrainers() {
        console.log("Loading trainers...");
        // This will be implemented by trainer-form.js
    }

    function loadCourses() {
        console.log("Loading courses...");
        // This will be implemented by courses-section.js
    }

    function toggleAdminInfo() {
        const infoCard = document.getElementById("adminInfo");
        infoCard.style.display = (infoCard.style.display === "block") ? "none" : "block";
    }

    function logout() {
        localStorage.removeItem('adminName');
        localStorage.removeItem('adminEmail');
        localStorage.removeItem('adminPhone');
        window.location.href = 'AdminLogin.html';
    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
        showDashboard();
        
        // Load admin info
        const adminName = localStorage.getItem('adminName') || 'Admin';
        const adminEmail = localStorage.getItem('adminEmail') || 'admin@infuspark.com';
        const adminPhone = localStorage.getItem('adminPhone') || 'N/A';
        
        const nameElement = document.getElementById('adminName');
        const emailElement = document.getElementById('adminEmail');
        const phoneElement = document.getElementById('adminPhone');
        
        if (nameElement) nameElement.textContent = adminName;
        if (emailElement) emailElement.textContent = adminEmail;
        if (phoneElement) phoneElement.textContent = adminPhone;
    });

    // Close admin info when clicking outside
    document.addEventListener('click', function(event) {
        const profile = document.querySelector('.admin-profile');
        const infoCard = document.getElementById("adminInfo");
        if (profile && !profile.contains(event.target)) {
            if (infoCard) infoCard.style.display = 'none';
        }
    });
  </script>
  <script src="fix-errors.js"></script>
  <script src="AdminDashBoard.js?v=3"></script>
  <script src="trainer-form.js?v=2"></script>
  <script src="courses-section.js?v=2"></script>
</body>
</html>
